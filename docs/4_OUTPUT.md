# Solver Output Format

This document describes the data format generated by the OptaPlanner solver.

---

## Overview

The solver generates entries in the **assignments** table with `type = 'staff'`.

```
INPUT                               OUTPUT
=====                               ======
assignments (type='physician') →    assignments (type='staff')
calculated needs               →    Optimized assignments
```

---

# 1. OUTPUT STRUCTURE

## Table: `assignments` (type = 'staff')

Each assignment is an entry in the assignments table:

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Unique identifier |
| date | DATE | Assignment date |
| period | ENUM | `morning` or `afternoon` |
| type | STRING | **`staff`** (fixed value) |
| person_id | UUID | ID of the assigned staff member |
| location_id | UUID | ID of the location |
| skill_id | UUID | Skill used (consultations or surgical) |
| procedure_id | UUID | Covered procedure (surgical block) |
| is_1r | BOOLEAN | First Responsibility role |
| is_2f | BOOLEAN | Second Closing role |
| is_3f | BOOLEAN | Third Closing role |

---

# 2. ASSIGNMENT TYPES

## 2.1 Consultation

```json
{
  "type": "staff",
  "person_id": "uuid-staff",
  "date": "2024-01-15",
  "period": "morning",
  "location_id": "d82c55ee-2964-49d4-a578-417b55b557ec",
  "skill_id": "skill-accueil-dermato",
  "procedure_id": null,
  "is_1r": false,
  "is_2f": false,
  "is_3f": false
}
```

## 2.2 Consultation with Closing Role

```json
{
  "type": "staff",
  "person_id": "uuid-staff",
  "date": "2024-01-15",
  "period": "morning",
  "location_id": "7c8abe96-0a6b-44eb-857f-ad69036ebc88",
  "skill_id": "skill-accueil-ophtalmo",
  "procedure_id": null,
  "is_1r": true,
  "is_2f": false,
  "is_3f": false
}
```

## 2.3 Surgical Block

```json
{
  "type": "staff",
  "person_id": "uuid-staff",
  "date": "2024-01-15",
  "period": "morning",
  "location_id": "86f1047f-c4ff-441f-a064-42ee2f8ef37a",
  "skill_id": "skill-instrumentiste",
  "procedure_id": "uuid-procedure",
  "is_1r": false,
  "is_2f": false,
  "is_3f": false
}
```

**Note**: For surgical block, `skill_id` references the unified `skills` table (skill_type = 'surgical').

## 2.4 Administrative

```json
{
  "type": "staff",
  "person_id": "uuid-staff",
  "date": "2024-01-15",
  "period": "afternoon",
  "location_id": "00000000-0000-0000-0000-000000000001",
  "skill_id": null,
  "procedure_id": null,
  "is_1r": false,
  "is_2f": false,
  "is_3f": false
}
```

---

# 3. OUTPUT CONSTRAINTS

## Closing Roles

If a location has `has_closing = true` and physicians are present:

| Situation | Constraint |
|-----------|------------|
| Physicians morning AND afternoon | `is_1r` and `is_2f` must be on the **same person** morning AND afternoon |
| Physicians morning only | `is_1r` and `is_2f` in morning, person can be in Admin in afternoon |
| Paul Jacquier Thursday+Friday | An `is_3f = true` must exist |

## Fixed Schedules

For staff with `has_flexible_schedule = false`:
- Each predefined shift must have a corresponding assignment
- The solver chooses the location, not the time slot

## Flexible Schedules

For staff with `has_flexible_schedule = true`:
- Number of assigned days must be **exactly** `days_per_week`
- No assignment during absence periods

---

# 4. SOLUTION SCORE

The solver also returns the solution score:

```json
{
  "score": {
    "hard": 0,
    "medium": 0,
    "soft": 12450
  },
  "feasible": true,
  "assignments": [...]
}
```

| Field | Description |
|-------|-------------|
| `hard` | Must be = 0 for a valid solution |
| `medium` | Should be = 0 ideally (all needs covered) |
| `soft` | Higher is better quality |
| `feasible` | `true` if `hard = 0` |

---

# 5. STATISTICS

The solver can provide additional statistics:

## Per Staff Member

| Statistic | Description |
|-----------|-------------|
| `days_assigned` | Number of days worked |
| `days_1r` | Number of days as 1R |
| `days_2f` | Number of days as 2F |
| `closing_score` | days_1R × 10 + days_2F × 12 |
| `days_site_p234` | Days at P2/P3/P4 sites |

## Per Need

| Statistic | Description |
|-----------|-------------|
| `need_required` | Number requested |
| `need_covered` | Number assigned |
| `deficit` | need_required - need_covered |

---

# 6. COMPLETE EXAMPLE

```json
{
  "score": {
    "hard": 0,
    "medium": 0,
    "soft": 15230
  },
  "feasible": true,
  "assignments": [
    {
      "type": "staff",
      "person_id": "1e5339aa-5e82-4295-b918-e15a580b3396",
      "date": "2024-01-15",
      "period": "morning",
      "location_id": "7c8abe96-0a6b-44eb-857f-ad69036ebc88",
      "skill_id": "skill-accueil-ophtalmo",
      "is_1r": true,
      "is_2f": false
    },
    {
      "type": "staff",
      "person_id": "1e5339aa-5e82-4295-b918-e15a580b3396",
      "date": "2024-01-15",
      "period": "afternoon",
      "location_id": "7c8abe96-0a6b-44eb-857f-ad69036ebc88",
      "skill_id": "skill-accueil-ophtalmo",
      "is_1r": true,
      "is_2f": false
    },
    {
      "type": "staff",
      "person_id": "5d3af9e3-674b-48d6-b54f-bd84c9eee670",
      "date": "2024-01-15",
      "period": "morning",
      "location_id": "86f1047f-c4ff-441f-a064-42ee2f8ef37a",
      "skill_id": "skill-instrumentiste",
      "procedure_id": "op-001"
    }
  ],
  "statistics": {
    "staff": {
      "1e5339aa-...": {
        "days_assigned": 4,
        "days_1r": 2,
        "days_2f": 0,
        "closing_score": 20
      }
    },
    "coverage": {
      "needs_total": 45,
      "needs_covered": 45,
      "deficit": 0
    }
  }
}
```

---

*See also: 1_DOMAIN_MODEL.md, 2_NEEDS_CALCULATION.md, 3_CONSTRAINTS.md*
